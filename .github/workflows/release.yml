name: Release

on:
    push:
        branches: [release]
    workflow_dispatch:

jobs:
    release:
        permissions:
            contents: write
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: macos-latest
                      args: --target aarch64-apple-darwin
                    - platform: macos-latest
                      args: --target x86_64-apple-darwin
                    - platform: ubuntu-24.04
                      args: ""
                    - platform: ubuntu-24.04-arm
                      args: ""
                    - platform: windows-latest
                      args: ""

        runs-on: ${{ matrix.platform }}
        steps:
            - uses: actions/checkout@v4

            - name: Install dependencies (Ubuntu only)
              if: matrix.platform == 'ubuntu-24.04' || matrix.platform == 'ubuntu-24.04-arm'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf xdg-utils

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2

            - name: Install Rust stable
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

            - name: Rust cache
              uses: swatinem/rust-cache@v2
              with:
                  workspaces: "./src-tauri -> target"

            - name: Install frontend dependencies
              run: bun install

            - uses: tauri-apps/tauri-action@v0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
                  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
              with:
                  tagName: v__VERSION__
                  releaseName: "Farmer v__VERSION__"
                  releaseBody: "See the assets to download this version and install."
                  releaseDraft: true
                  prerelease: false
                  args: ${{ matrix.args }} --features vendored-openssl

    flatpak:
        needs: release
        runs-on: ubuntu-24.04
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v4

            - name: Get version
              id: version
              run: |
                  VERSION=$(grep '"version"' src-tauri/tauri.conf.json | sed 's/.*"version": *"\([^"]*\)".*/\1/')
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Download deb from release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  mkdir -p src-tauri/target/release/bundle/deb
                  gh release download v${{ steps.version.outputs.version }} --pattern "farmer_*_amd64.deb" --dir src-tauri/target/release/bundle/deb/
                  ls -la src-tauri/target/release/bundle/deb/
                  mv src-tauri/target/release/bundle/deb/farmer_*_amd64.deb src-tauri/target/release/bundle/deb/farmer_${{ steps.version.outputs.version }}_amd64.deb || true

            - name: Install flatpak-builder
              run: |
                  sudo apt-get update
                  sudo apt-get install -y flatpak flatpak-builder
                  flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

            - name: Build Flatpak
              working-directory: src-tauri
              run: |
                  flatpak-builder --user --install-deps-from=flathub --arch=x86_64 --force-clean build-dir flatpak-builder.yaml
                  flatpak-builder --user --repo=repo --force-clean build-dir flatpak-builder.yaml
                  flatpak build-bundle repo farmer.flatpak com.omznc.farmer

            - name: Upload Flatpak to Release
              uses: softprops/action-gh-release@v2
              with:
                  files: src-tauri/farmer.flatpak
                  tag_name: v${{ steps.version.outputs.version }}
                  draft: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
